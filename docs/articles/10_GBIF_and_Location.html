<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GBIF And Spatial Data • compbio2020</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="GBIF And Spatial Data">
<meta property="og:description" content="compbio2020">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">compbio2020</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/00_Syllabus_and_Expectations.html">Syllabus</a>
    </li>
    <li>
      <a href="../articles/01_Getting_Started_with_R.html">Starting with R</a>
    </li>
    <li>
      <a href="../articles/02_Starting_with_Data.html">Starting with data</a>
    </li>
    <li>
      <a href="../articles/03_Manipulating_Data.html">Manipulating, analyzing and exporting data with tidyverse</a>
    </li>
    <li>
      <a href="../articles/04-plotting.html">Data visualization with ggplot2</a>
    </li>
    <li>
      <a href="../articles/05_Functions.html">Functions and repeatability</a>
    </li>
    <li>
      <a href="../articles/06_Exploration_Setup.html">Exploration</a>
    </li>
    <li>
      <a href="../articles/08_linear_models.html">Introduction to Linear Models: Building and Interpreting Linear Regressions</a>
    </li>
    <li>
      <a href="../articles/09_Tree_of_life.html">GeneticData</a>
    </li>
    <li>
      <a href="../articles/10_GBIF_and_Location.html">GBIF And Spatial Data</a>
    </li>
    <li>
      <a href="../articles/HomeworkFive.html">Homework Five</a>
    </li>
    <li>
      <a href="../articles/HomeworkFour.html">Homework Four</a>
    </li>
    <li>
      <a href="../articles/HomeworkThree.html">Homework Three</a>
    </li>
    <li>
      <a href="../articles/HomeworkTwo.html">Homework Two</a>
    </li>
    <li>
      <a href="../articles/ProjectOne.html">ProjectOne</a>
    </li>
    <li>
      <a href="../articles/ProjectTwo.html">Project Two</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="10_GBIF_and_Location_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>GBIF And Spatial Data</h1>
            
      
      
      <div class="hidden name"><code>10_GBIF_and_Location.Rmd</code></div>

    </div>

    
    
<p>This week, we will be starting with geospatial data and mapping. Today, we will begin with locality data in GBIF. GBIF is a website for aggregating location data from other sources.</p>
<p>We will work with two packages today. One is <a href="https://www.gbif.org/tool/81747/rgbif">RGBIF</a>, an interface to <a href="https://www.gbif.org/">GBIF</a> data maintained by the <a href="https://ropensci.org/">ROpenSci</a> group.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"rgbif"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"leaflet"</span><span class="op">)</span></pre></div>
<p>Later in this lesson, we will also use the <code>rotl</code> package we’ve seen last week.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rotl/">rotl</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif">rgbif</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/">leaflet</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></pre></div>
<p>First, we’re going to try an example for one ant. We will query locality data and map it in a few ways. Then, you will figure out how to make the process of mapping data iterable over a set of taxa.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span><span class="op">(</span><span class="st">"Atta mexicana"</span><span class="op">)</span></pre></div>
<p>Next, we’re going to use <code>occ_search</code> to search the GBIF database for where these things are occurring.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
 <span class="va">occurences</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_search.html">occ_search</a></span><span class="op">(</span>taxonKey <span class="op">=</span> <span class="fl">5035745</span>, limit <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></pre></div>
<p>Next, we will filter the resultant dataset to name and lat and longitude data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">no_na</span> <span class="op">&lt;-</span> <span class="va">occurences</span><span class="op">$</span><span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">scientificName</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>And finally, we will plot the data using <code>leaflet</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">k</span> <span class="op">&lt;-</span> <span class="fu">leaflet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span>, popup <span class="op">=</span> <span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span><span class="op">)</span></pre></div>
<p>This looks much like plotting with <code>ggplot</code> and tidyverse. That’s because leaflet is based on the same principles. We establish a canvas and the data in the first line, then we add tiles (the actual map we will use), and then we add our points. When we think about it, this is quite similar to establishing a ggplot canvas, the axes, and the points to plot.</p>
<p>One point is easy. How often do we only want one point, though? Probably, we will want to plot several species. First, with a partner, work out how to get GBIF ids for a set of taxa.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">ants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Martialis"</span>, <span class="st">"Atta"</span>, <span class="st">"Ectatomma"</span>, <span class="st">"Tatuidris"</span>, <span class="st">"Aneuretus"</span>, <span class="st">"Xymmer"</span>, <span class="st">"Aenictus"</span><span class="op">)</span>

<span class="co">#Get GBIF ids for our vector of species.</span>


<span class="va">ids</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">ant</span> <span class="kw">in</span> <span class="va">ants</span><span class="op">)</span><span class="op">{</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ant</span><span class="op">)</span>
   <span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span><span class="op">(</span><span class="va">ant</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">raw</span><span class="op">)</span>
   <span class="va">ids</span><span class="op">[</span><span class="va">ant</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">raw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">key</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Now, we will get the actual specimen occurrences for these ants. Practice using an apply function to do this. Inspect the object you’ve queried when you’ve completed your loop. Have we dealt with an object like this before?</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">ids</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">ant</span> <span class="kw">in</span> <span class="va">ants</span><span class="op">)</span><span class="op">{</span>
   <span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span><span class="op">(</span><span class="va">ant</span><span class="op">)</span>
   <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_search.html">occ_search</a></span><span class="op">(</span>taxonKey <span class="op">=</span> <span class="va">raw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">key</span>, limit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>This is a vector or dataframes. Each individual query made it’s own dataframe. For simplicity, lets combine them into one dataframe object.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co">#Combine the resultant dataframes into one large dataframe</span>
<span class="va">mega_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"column_label"</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">ant</span> <span class="kw">in</span> <span class="va">ants</span><span class="op">)</span><span class="op">{</span>
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">ant</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Since we will be plotting these with a map, we need complete data in both columns - lat and long. Let’s drop any columns without data in both.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co">#Drop rows with NA values in the lat and long</span>
<span class="va">no_na</span> <span class="op">&lt;-</span> <span class="va">mega_df</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">scientificName</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>Now let’s take a peek at our results!</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># Plot the dataframe of observations</span>
<span class="va">k</span> <span class="op">&lt;-</span> <span class="fu">leaflet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span>, popup <span class="op">=</span> <span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span><span class="op">)</span></pre></div>
<div id="geospatial-choose-your-own-adventure" class="section level1">
<h1 class="hasAnchor">
<a href="#geospatial-choose-your-own-adventure" class="anchor"></a>GeoSpatial Choose Your Own Adventure</h1>
<p>Below are six code snippets to do different types of map-based plotting. With a partner, discuss what you think would be interesting or important to view in these data. Choose a block of code to modify to accomplish your visualization. We will reconvene in about 30 minutes and do a Round Robin showing everyone’s maps. <em>Have Fun!</em></p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircles</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span><span class="op">)</span></pre></div>
<div id="draw-point-sizes-from-a-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#draw-point-sizes-from-a-distribution" class="anchor"></a>Draw point sizes from a distribution</h3>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span>, radius <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">4</span>, <span class="fl">10</span><span class="op">)</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'red'</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="cluster-observations" class="section level3">
<h3 class="hasAnchor">
<a href="#cluster-observations" class="anchor"></a>Cluster observations</h3>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span>, clusterOptions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-options.html">markerClusterOptions</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="size-points-by-number-of-observations" class="section level3">
<h3 class="hasAnchor">
<a href="#size-points-by-number-of-observations" class="anchor"></a>Size points by number of observations</h3>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">no_na</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">decimalLatitude</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_areas <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span><span class="op">(</span><span class="op">~</span><span class="va">decimalLongitude</span>, <span class="op">~</span><span class="va">decimalLatitude</span>, radius <span class="op">=</span> <span class="op">~</span><span class="va">n_areas</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'red'</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="color-points-by-species" class="section level3">
<h3 class="hasAnchor">
<a href="#color-points-by-species" class="anchor"></a>Color points by species</h3>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorBin</a></span><span class="op">(</span>
  palette <span class="op">=</span> <span class="st">"Blues"</span>,
  <span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span>,
  pretty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">levs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span><span class="op">)</span>
<span class="va">factpal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorFactor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">topo.colors</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="va">levs</span><span class="op">)</span>

<span class="va">no_na</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">scientificName</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span><span class="op">(</span>
    <span class="op">~</span><span class="va">decimalLongitude</span>, 
    <span class="op">~</span><span class="va">decimalLatitude</span>,
    color <span class="op">=</span> <span class="op">~</span><span class="fu">factpal</span><span class="op">(</span><span class="va">scientificName</span><span class="op">)</span>,
    stroke <span class="op">=</span> <span class="cn">FALSE</span>, fillOpacity <span class="op">=</span> <span class="fl">0.5</span>
  <span class="op">)</span> </pre></div>
</div>
<div id="set-view-width" class="section level3">
<h3 class="hasAnchor">
<a href="#set-view-width" class="anchor"></a>Set view Width</h3>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorBin</a></span><span class="op">(</span>
  palette <span class="op">=</span> <span class="st">"Blues"</span>,
  <span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span>,
  pretty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">levs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">no_na</span><span class="op">$</span><span class="va">scientificName</span><span class="op">)</span>
<span class="va">factpal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorFactor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">topo.colors</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="va">levs</span><span class="op">)</span>

<span class="va">no_na</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">scientificName</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span><span class="op">(</span>
    <span class="op">~</span><span class="va">decimalLongitude</span>, 
    <span class="op">~</span><span class="va">decimalLatitude</span>,
    color <span class="op">=</span> <span class="op">~</span><span class="fu">factpal</span><span class="op">(</span><span class="va">scientificName</span><span class="op">)</span>,
    stroke <span class="op">=</span> <span class="cn">FALSE</span>, fillOpacity <span class="op">=</span> <span class="fl">0.5</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html">setView</a></span><span class="op">(</span> lng <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>,
            lat <span class="op">=</span> <span class="fl">20</span>,
            zoom <span class="op">=</span> <span class="fl">11</span> <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html">setMaxBounds</a></span><span class="op">(</span> lng1 <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>,
                lat1 <span class="op">=</span> <span class="fl">19.432241</span>,
                lng2 <span class="op">=</span> <span class="op">-</span><span class="fl">98</span>,
                lat2 <span class="op">=</span> <span class="fl">20</span> <span class="op">)</span></pre></div>
</div>
<div id="extra-map-color-options-base-maps" class="section level3">
<h3 class="hasAnchor">
<a href="#extra-map-color-options-base-maps" class="anchor"></a>Extra map color options (base maps)</h3>
<p><a href="https://rstudio.github.io/leaflet/basemaps.html" class="uri">https://rstudio.github.io/leaflet/basemaps.html</a></p>
</div>
<div id="mapping-a-tree-to-space" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-a-tree-to-space" class="anchor"></a>Mapping a tree to space</h2>
<p>We will need one package we haven’t used yet, Liam Revell’s Phytools.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"liamrevell/phytools"</span><span class="op">)</span></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/liamrevell/phytools">phytools</a></span><span class="op">)</span></pre></div>
<p>Plotting a phylogeny to a map is a fairly simple task, but has a lot of data preparation work involved. The basic steps look like this:</p>
<ol style="list-style-type: decimal">
<li>Synchronize names between GBIF and OpenTree</li>
<li>Format GBIF data into a matrix</li>
<li>Add branch lengths to our tree</li>
<li>Plot</li>
</ol>
<p>You may have noticed that the GBIF package includes citation information in the scientificName column. We will need to remove that. To do this, let’s try the <code>strsplit</code> function. This function splits a character string on a defined character and returns a vector of the elements in that character string.</p>
<p>For example:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">my_string</span> <span class="op">=</span> <span class="st">"This is my string"</span>
<span class="va">split_up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">my_string</span>, <span class="st">" "</span><span class="op">)</span>
<span class="va">split_up</span></pre></div>
<p>Try indexing this object. What do you need to do to access data? Now, with a partner, make this iterable across every row in the <code>scientificName</code> column. Then, unite the split objects into one new column called <code>genusSpecies</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">split_names</span> <span class="op">&lt;-</span> <span class="va">no_na</span> <span class="op">%&gt;%</span> 
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>genus <span class="op">=</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">scientificName</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">scientificName</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
<span class="fu">unite</span><span class="op">(</span>col <span class="op">=</span> <span class="va">genusSpecies</span>, <span class="va">genus</span>, <span class="va">species</span><span class="op">)</span></pre></div>
<p>If you look at the data, there are some obviously mistaken values in there. For example, BOLD is not an ant species. Let’s drop that.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="co"># Use ROTL to resolve names</span>

<span class="va">no_bold</span> <span class="op">&lt;-</span> <span class="va">split_names</span><span class="op">[</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"BOLD"</span>, <span class="va">split_names</span><span class="op">$</span><span class="va">genusSpecies</span>, invert <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> , <span class="op">]</span></pre></div>
<p>We also ended up with far more ant taxa than I thought. What a nice problem to have! But let’s filter down to, say, five of them:</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">a_couple_ants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Martialis_heureka"</span>, <span class="st">"Atta_mexicana"</span>, <span class="st">"Atta_cephalotes"</span>, <span class="st">"Atta_sexdens"</span>, <span class="st">"Atta_Fabricius"</span><span class="op">)</span>
<span class="va">subset_data</span> <span class="op">&lt;-</span> <span class="va">no_bold</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">genusSpecies</span> <span class="op">%in%</span> <span class="va">a_couple_ants</span><span class="op">)</span></pre></div>
<p>Now, let’s use ROTL to make sure we don’t have spelling errors.</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">reconciled_names</span> <span class="op">&lt;-</span> <span class="fu">rotl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rotl/reference/tnrs_match_names.html">tnrs_match_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">subset_data</span><span class="op">$</span><span class="va">genusSpecies</span><span class="op">)</span><span class="op">)</span>
<span class="va">good_names</span> <span class="op">&lt;-</span>  <span class="va">reconciled_names</span> <span class="op">%&gt;%</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>Now, we will query our tree from OpenTree.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu">rotl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rotl/reference/tol_induced_subtree.html">tol_induced_subtree</a></span><span class="op">(</span><span class="va">good_names</span><span class="op">$</span><span class="va">ott_id</span>, label<span class="op">=</span><span class="st">"name"</span><span class="op">)</span></pre></div>
<p>Now, we must combine our GBIF data and our taxon names into a matrix, a two-dimensional data structure with fewer neat data parsing features than a dataframe or tibble. These structures are often preferred when speed is an issue. Matrices can only be one type, which means we must add the row names after generating the object.</p>
<p>And the big reveal! Let’s overlay our OpenTree with our map:</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span>
<span class="va">cols</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu">Ntip</span><span class="op">(</span><span class="va">tree</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span>

<span class="va">obj</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phylo.to.map.html">phylo.to.map</a></span><span class="op">(</span><span class="va">tree</span>,<span class="va">only_lat_long</span>, plot<span class="op">=</span><span class="cn">FALSE</span>, direction<span class="op">=</span><span class="st">"rightwards"</span><span class="op">)</span></pre></div>
<p>Oh no! What has gone wrong?</p>
<p>This tree has several quirks. Have a look at the object and see if you can spot them.</p>
<pre><code>
#Answer here

- No branch lengths
- Not fully bifurcating
</code></pre>
<p>First, let’s resolve the polytomy issue. We will do this using Ape’s <code>multi2di</code> function, which arbitrarily resolves polytomies. In real life, you would probably want to think about this a little more.:</p>
<p>We’ll also need to add some branch lengths. In our case, we will draw them from an exponential distribution. The exponential is often assumed to be a reasonable approximation for banch lengths - you’ll hear more about this if you take my systematics lab ;)</p>
<p>In our case, we will use <code>rexp</code> to make the draws, and we will map them to a new attribute <code>edge.length</code> that is a standard attribute of the tree object. In reality, you would likely not want to do this for a publication quality analysis, and would want to estimate branch lengths from data. But being able to rescale branch lengths is a good skill for sensitivity and other similar analyses.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">tree</span><span class="op">$</span><span class="va">edge.length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">Nnode</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span>
<span class="va">tree</span><span class="op">$</span><span class="va">edge.length</span></pre></div>
<p>Now let’s try that map again.</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="va">plot_object</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phylo.to.map.html">phylo.to.map</a></span><span class="op">(</span><span class="va">tree</span>,<span class="va">only_lat_long</span>, plot<span class="op">=</span><span class="cn">FALSE</span>, direction<span class="op">=</span><span class="st">"rightwards"</span><span class="op">)</span></pre></div>
<p>Finally, we will actually plot to space.</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">plot_object</span>,direction<span class="op">=</span><span class="st">"rightwards"</span>,colors<span class="op">=</span><span class="va">cols</span>,cex.points<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,
    lwd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>,ftype<span class="op">=</span><span class="st">"i"</span><span class="op">)</span></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by April Wright.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
